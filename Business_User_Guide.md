# 金融数据智能分析系统业务使用手册

## 1. 系统概述

本系统是一个基于机器学习的金融数据推荐模型，旨在帮助业务人员：

1. 自动处理复杂的金融Excel数据
2. 构建推荐模型识别潜在高价值客户
3. 提供可解释的推荐结果，帮助理解模型决策依据
4. 检测模型的公平性，确保对不同群体的客户公平对待
5. 使用深度学习模型进行更复杂的特征学习和预测

## 2. 系统主要功能

### 2.1 数据处理与特征工程
- 自动读取并处理多个Excel格式的金融数据文件
- 智能识别数据字段类型（数值型、类别型等）
- 自动计算衍生特征（如总额、平均值等）
- 生成用于机器学习的结构化宽表数据

### 2.2 智能推荐与预测
- 使用先进的GBDT+LR算法构建推荐模型
- 自动训练模型并优化参数
- 对新数据进行批量推荐
- 生成推荐概率和客户价值评分

### 2.3 模型可解释性分析
- 提供特征重要性排序，识别关键影响因素
- 生成可视化图表（如ROC曲线）
- 为每个预测结果提供决策依据说明
- 可将(推荐/授信/预警)模型训练日志放入大模型进行分析，输出银行业务人员可以理解的解读报告，通过模型分析赋能业务

### 2.4 模型公平性检测
- 检测模型对不同敏感群体的公平性
- 计算多种公平性指标，包括：
  - 人口统计学公平性(Demographic Parity)
  - 机会均等(Equal Opportunity)
  - 均衡几率(Equalized Odds)
  - 预测公平性(Predictive Parity)
- 支持自定义敏感属性字段进行公平性分析

### 2.5 深度学习模型
- 使用PyTorch构建深度神经网络模型
- 训练深度学习模型进行更复杂的特征学习和预测
- 提供深度学习模型的预测结果

## 3. 使用流程

### 3.1 建模阶段

#### 步骤1：配置数据处理规则
根据业务需求配置以下文件，存放在`config/`目录：
1. `primary_key.csv`：定义各数据文件的主键字段
2. `category_type.csv`：指定需要作为类别处理的字段
3. `label_key.csv`：定义标签文件的信息
4. `sensitive_attr.csv`：定义用于公平性检测的敏感属性字段

**注意：必须先完成配置文件的设置，才能进行后续的数据转换处理。**

配置文件格式要求详见第7节"配置文件说明"。

#### 步骤2：准备训练数据
将历史业务数据按以下要求准备：
- 数据文件格式：Excel文件（.xlsx）
- 文件存放位置：`data_train/`目录
- 标签文件：包含业务结果的Excel文件，存放在`label_train/`目录

#### 步骤3：执行建模流程
在系统终端依次运行以下命令：
```bash
# 1. 数据转换处理
python convert_train_data.py

# 2. 添加业务标签
python add_train_label.py

# 3. 训练预测模型
python train_model.py

# 4. 训练深度学习模型（可选）
python train_model_dl.py
```

执行完成后，系统会生成：
- 模型文件（`gbdt_model.pkl`和`lr_model.pkl`）
- 模型评估报告（`roc_curve.png`等）
- 特征重要性分析（`gbdt_feature_importance.csv`）
- 可将(推荐/授信/预警)模型训练日志放入大模型进行分析
- 深度学习模型文件（`dl_model.pth`）

### 3.2 预测阶段

#### 步骤1：准备待预测数据
- 将需要预测的客户数据整理成Excel格式
- 文件存放位置：`data_predict/`目录

#### 步骤2：执行预测分析
在系统终端运行以下命令：
```bash
# 1. 预测数据转换
python convert_predict_data.py

# 2. 执行预测（快速模式）
python predict.py

# 或者执行预测并生成详细解释（较慢）
python predict.py --shap

# 3. 使用深度学习模型进行预测（可选）
python predict_dl.py
```

#### 步骤3：执行公平性检测
在系统终端运行以下命令：
```bash
# 执行模型公平性检测
python check_model_fairness.py
```

#### 步骤4：查看预测结果
预测结果保存在：`output/prediction_results.csv`

文件包含以下信息：
- `Id`：客户标识
- `PredictedProb`：预测概率（0-1之间，越接近1表示价值越高）
- `top_features`：影响预测的最重要3个因素（仅在使用--shap参数时显示）
- `top_rules`：模型决策的3条关键规则（仅在使用--shap参数时显示）

公平性检测结果保存在：`output/fairness_metrics.csv`

文件包含以下公平性指标：
- `Metric`：公平性指标名称
- `Score`：公平性得分（0-1之间，越接近1表示越公平）

## 4. 预测结果解读

### 4.1 推荐概率说明
- **0.0-0.3**：低价值客户
- **0.3-0.7**：中等价值客户
- **0.7-1.0**：高价值客户

### 4.2 特征重要性解读
系统会输出类似以下的特征重要性信息：
```
📊 GBDT Top 20 重要特征 (含影响方向):
                                           Feature  Gain_Importance  Split_Importance Impact_Direction
数据集_同比_带金额_20241231_1__日期_2023_False       817.963905        100              Positive
分渠道汇款业务分析_20241231_笔数_渠道_网银       294.209710         85              Negative
```

解读方法：
- **Feature**：特征名称，表示数据字段
- **Gain_Importance**：重要性分数，数值越大影响越大
- **Split_Importance**：分裂次数，表示该特征被用于分裂的次数
- **Impact_Direction**：影响方向
  - Positive：该特征值增加会提高预测概率
  - Negative：该特征值增加会降低预测概率

### 4.3 决策规则解读
当使用`--shap`参数时，系统为每个预测结果提供决策依据说明，例如：
```
   1. 数据集_同比_带金额_20241231_1__日期_2023 == 'True'
   2. 分渠道汇款业务分析_20241231_笔数_渠道_网银 <= 13.5000
```

### 4.4 公平性指标解读
系统会输出类似以下的公平性指标：
```
📊 模型公平性指标:
   Demographic Parity: 0.9996
   Equal Opportunity: 0.9474
   Equalized Odds: 0.9737
   Predictive Parity: 0.0
```

解读方法：
- **Demographic Parity (人口统计学公平性)**：衡量模型对不同群体的预测正类概率是否相近
- **Equal Opportunity (机会均等)**：衡量模型对不同群体中真正例的识别能力是否相近
- **Equalized Odds (均衡几率)**：综合衡量模型对不同群体的真阳性率和假阳性率是否相近
- **Predictive Parity (预测公平性)**：衡量模型对不同群体的预测准确性是否相近

所有指标得分范围为0-1，越接近1表示模型越公平。

## 5. 注意事项

### 5.1 数据准备要求
- 确保Excel文件格式正确，无损坏
- 文件名和列名应使用英文或数字，避免特殊字符
- 数值型数据应为纯数字格式，避免包含文本或符号

### 5.2 模型维护
- 建议每季度使用最新数据重新训练模型
- 当业务环境发生重大变化时，应及时更新模型

### 5.3 推荐使用建议
- 推荐结果仅供参考，应结合业务经验进行综合判断
- 对于高价值客户，建议优先跟进和营销

### 5.4 公平性检测建议
- 定期执行公平性检测，确保模型不会对特定群体产生歧视
- 当公平性指标得分较低时，应分析原因并考虑重新训练模型
- 可根据不同敏感属性分别进行公平性检测

## 6. 常见问题解答

### Q1: 推荐结果不准确怎么办？
A: 请检查输入数据质量，确保数据完整且格式正确。如问题持续存在，请联系技术支持团队。

### Q2: 如何解释某个客户的高价值推荐？
A: 使用`python predict.py --shap`命令重新预测，系统会生成该客户的详细解释报告。

### Q3: 可以自定义风险阈值吗？
A: 可以在业务应用中根据实际需求调整风险阈值，建议先使用默认阈值进行测试。

### Q4: 公平性检测得分较低怎么办？
A: 当公平性检测得分较低时，建议：
1. 检查敏感属性的选择是否合理
2. 分析不同群体的数据分布是否存在偏差
3. 考虑重新训练模型或调整模型参数
4. 联系技术支持团队获取进一步帮助

## 7. 配置文件说明

### 7.1 主键配置文件 (primary_key.csv)
用于定义各Excel数据文件的主键字段，确保数据正确关联。

**格式要求：**
```
file_name,sheet_name,primary_key
文件名,工作表名,主键字段名
```

**配置示例：**
```
file_name,sheet_name,primary_key
分渠道汇款业务分析_20241231.xlsx,,cusno
数据集-环比-带金额_20241231.xlsx,,ci
```

**字段说明：**
- `file_name`：Excel文件名（必须与data_train/目录下的文件名完全一致）
- `sheet_name`：工作表名（如果Excel文件只有一个工作表，可留空）
- `primary_key`：主键字段名（用于唯一标识每条记录的字段）

### 7.2 类别特征配置文件 (category_type.csv)
用于指定需要强制作为类别特征处理的字段，解决数值型字段但业务上应为类别型的问题。

**格式要求：**
```
file_name,column_name,feature_type
文件名,列名,特征类型
```

**配置示例：**
```
file_name,column_name,feature_type
数据集-环比-带金额_20241231.xlsx,网点号,category
分渠道汇款业务分析_20241231.xlsx,BELONG_BRNO,category
```

**字段说明：**
- `file_name`：Excel文件名
- `column_name`：需要强制为类别特征的列名
- `feature_type`：特征类型（固定值为category）

### 7.3 标签配置文件 (label_key.csv)
用于定义标签文件的信息，系统将根据此配置从标签文件中提取目标变量。

**格式要求：**
```
file_name,sheet_name,label_key
文件名,工作表名,标签列名
```

**配置示例：**
```
file_name,sheet_name,label_key
现金管理客户数全量2025_08（销户因素调整后).xlsx,2024Raw,本地支薪
```

**字段说明：**
- `file_name`：标签Excel文件名（必须与label_train/目录下的文件名完全一致）
- `sheet_name`：工作表名（如果Excel文件只有一个工作表，可留空）
- `label_key`：标签列名（包含目标变量的列名）

### 7.4 敏感属性配置文件 (sensitive_attr.csv)
用于定义用于公平性检测的敏感属性字段，系统将根据此配置从指定文件中提取敏感属性进行公平性分析。

**格式要求：**
```
file_name,sheet_name,column_name
文件名,工作表名,列名
```

**配置示例：**
```
file_name,sheet_name,column_name
分渠道汇款业务分析_20241231.xlsx,,BELONG_BRNO
```

**字段说明：**
- `file_name`：包含敏感属性的Excel文件名
- `sheet_name`：工作表名（如果Excel文件只有一个工作表，可留空）
- `column_name`：敏感属性列名（用于公平性分析的字段）

## 8. 技术支持

如有使用问题，请联系技术支持团队：
- 邮箱：wonglaitung@gmail.com
- 电话：+852-XXXX-XXXX